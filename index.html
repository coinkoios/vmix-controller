<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta http-equiv="Access-Control-Allow-Methods" content="GET, POST, OPTIONS">
    <meta http-equiv="Access-Control-Allow-Headers" content="Content-Type">
    <title>vMix PowerPoint Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2d2d2d;
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid #3d3d3d;
        }

        .main-content {
            flex: 1;
            display: flex;
            padding: 2rem;
            gap: 2rem;
        }

        .preview-section {
            flex: 3;
            background: #2d2d2d;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .preview-image {
            width: 100%;
            aspect-ratio: 16/9;
            background: #1a1a1a;
            border: 1px solid #3d3d3d;
            border-radius: 4px;
        }

        .controls-section {
            flex: 1;
            background: #2d2d2d;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .slide-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        button {
            background: #4a4a4a;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        button:hover {
            background: #5a5a5a;
        }

        button:active {
            background: #3a3a3a;
        }

        .status {
            padding: 0.5rem;
            text-align: center;
            border-radius: 4px;
        }

        .status.connected {
            background: #1c4c1c;
        }

        .status.disconnected {
            background: #4c1c1c;
        }

        .slide-info {
            text-align: center;
            font-size: 1.2rem;
        }

        .return-feed {
            width: 100%;
            aspect-ratio: 16/9;
            background: #1a1a1a;
            border: 1px solid #3d3d3d;
            border-radius: 4px;
            margin-top: 1rem;
        }

        .checklist {
            margin: 10px;
            padding: 10px;
            background: #333;
            border-radius: 4px;
        }

        .checklist ul {
            list-style: none;
            padding: 0;
        }

        .checklist li {
            margin: 5px 0;
            padding: 5px;
            background: #444;
            border-radius: 2px;
        }

        .vmix-call-frame {
            width: 100%;
            aspect-ratio: 16/9;
            background: #1a1a1a;
            border: 1px solid #3d3d3d;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>vMix PowerPoint Controller</h1>
        <div id="user-info" style="font-size: 0.9em; margin-top: 5px;"></div>
    </div>

    <div class="main-content">
        <div class="preview-section">
            <h2>vMix Call</h2>
            <!-- vMix Call will be embedded here -->
            <iframe id="vmix-call-frame" class="vmix-call-frame" frameborder="0" allow="camera;microphone;fullscreen"></iframe>
        </div>

        <div class="controls-section">
            <div id="connection-status" class="status disconnected">Disconnected</div>
            <div class="slide-controls">
                <button id="prev-slide">Previous Slide</button>
                <button id="next-slide">Next Slide</button>
            </div>
            <div id="slide-info" class="slide-info">Slide 0 of 0</div>
        </div>
    </div>

    <script>
        class VMixController {
            constructor() {
                this.roles = {
                    HOST: 'host',
                    GUEST: 'guest',
                    PRODUCER: 'producer'
                };

                this.initializeElements();
                this.setupRemoteAccess();
            }

            initializeElements() {
                this.prevButton = document.getElementById('prev-slide');
                this.nextButton = document.getElementById('next-slide');
                this.statusElement = document.getElementById('connection-status');
                this.slideInfo = document.getElementById('slide-info');
                
                // Get vMix Call parameters and role from URL
                const urlParams = new URLSearchParams(window.location.href.split('?')[1] || '');
                this.callKey = urlParams.get('Key');
                this.name = urlParams.get('Name');
                this.role = urlParams.get('Role')?.toLowerCase() || 'guest';
                
                // If no parameters in URL, try to get from localStorage
                if (!this.callKey || !this.name) {
                    this.showCallSetupDialog();
                } else {
                    this.setupVMixCall();
                }
            }

            showCallSetupDialog() {
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #2d2d2d;
                    padding: 20px;
                    border-radius: 8px;
                    z-index: 1000;
                    box-shadow: 0 0 20px rgba(0,0,0,0.5);
                `;

                dialog.innerHTML = `
                    <h3 style="margin-bottom: 15px;">vMix Call Setup</h3>
                    <div style="margin-bottom: 10px;">
                        <label>Call Code:</label>
                        <input type="text" id="call-key" placeholder="Enter vMix Call code" style="width: 150px; padding: 5px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label>Your Name:</label>
                        <input type="text" id="user-name" placeholder="Enter your name" style="width: 150px; padding: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>Role:</label>
                        <select id="user-role" style="width: 150px; padding: 5px;">
                            <option value="guest">Guest</option>
                            <option value="host">Host</option>
                            <option value="producer">Producer</option>
                        </select>
                    </div>
                    <div style="text-align: right;">
                        <button id="setup-btn" style="padding: 8px 15px; background: #4a4a4a; border: none; color: white; border-radius: 4px; cursor: pointer;">Connect</button>
                    </div>
                `;

                document.body.appendChild(dialog);

                document.getElementById('setup-btn').onclick = () => {
                    const key = document.getElementById('call-key').value;
                    const name = document.getElementById('user-name').value;
                    const role = document.getElementById('user-role').value;

                    if (key && name) {
                        // Save to localStorage for future use
                        localStorage.setItem('vmixCallKey', key);
                        localStorage.setItem('vmixCallName', name);
                        localStorage.setItem('vmixCallRole', role);

                        // Update URL with parameters
                        const newUrl = new URL(window.location.href);
                        newUrl.searchParams.set('Key', key);
                        newUrl.searchParams.set('Name', name);
                        newUrl.searchParams.set('Role', role);
                        window.history.pushState({}, '', newUrl);

                        this.callKey = key;
                        this.name = name;
                        this.role = role;
                        
                        document.body.removeChild(dialog);
                        this.setupVMixCall();
                    }
                };
            }

            setupVMixCall() {
                const vmixCallFrame = document.getElementById('vmix-call-frame');
                const callUrl = `https://advanced.vmixcall.com/call.htm?Key=${this.callKey}&Name=${this.name}`;
                console.log('Setting vMix Call URL:', callUrl);
                vmixCallFrame.src = callUrl;

                // Update user info display
                const userInfo = document.getElementById('user-info');
                userInfo.textContent = `Connected as: ${this.name} (${this.role})`;

                // Check for producer IP and port in URL parameters
                const urlParams = new URLSearchParams(window.location.href.split('?')[1] || '');
                const producerIp = urlParams.get('ProducerIP') || localStorage.getItem('producerIp');
                const producerPort = urlParams.get('ProducerPort') || localStorage.getItem('producerPort');

                if (producerIp && producerPort) {
                    this.vmixHost = `http://${producerIp}:${producerPort}`;
                    localStorage.setItem('producerIp', producerIp);
                    localStorage.setItem('producerPort', producerPort);
                    
                    if (this.role === this.roles.GUEST) {
                        this.hideSlideControls();
                    } else {
                        this.initializeEventListeners();
                    }
                    
                    this.connect();
                } else if (this.role === this.roles.PRODUCER) {
                    this.promptForConnection();
                } else {
                    this.statusElement.textContent = 'Waiting for Producer Connection';
                }
            }

            hideSlideControls() {
                const slideControls = document.querySelector('.slide-controls');
                if (slideControls) {
                    slideControls.style.display = 'none';
                }
                // Keep the status and slide info visible
                this.slideInfo.style.marginTop = '20px';
            }

            promptForConnection() {
                const savedIp = localStorage.getItem('producerIp') || '192.168.0.12';
                const savedPort = localStorage.getItem('producerPort') || '8088';
                
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #2d2d2d;
                    padding: 20px;
                    border-radius: 8px;
                    z-index: 1000;
                    box-shadow: 0 0 20px rgba(0,0,0,0.5);
                `;

                dialog.innerHTML = `
                    <h3 style="margin-bottom: 15px;">Connect to vMix</h3>
                    <div style="margin-bottom: 10px;">
                        <label>IP Address:</label>
                        <input type="text" id="vmix-ip" value="${savedIp}" style="width: 150px; padding: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>Port:</label>
                        <input type="text" id="vmix-port" value="${savedPort}" style="width: 150px; padding: 5px;">
                    </div>
                    <div style="text-align: right;">
                        <button id="connect-btn" style="padding: 8px 15px; background: #4a4a4a; border: none; color: white; border-radius: 4px; cursor: pointer;">Connect</button>
                    </div>
                `;

                document.body.appendChild(dialog);

                document.getElementById('connect-btn').onclick = () => {
                    const ip = document.getElementById('vmix-ip').value;
                    const port = document.getElementById('vmix-port').value;

                    if (ip && port) {
                        localStorage.setItem('producerIp', ip);
                        localStorage.setItem('producerPort', port);
                        this.vmixHost = `http://${ip}:${port}`;
                        document.body.removeChild(dialog);
                        this.initializeEventListeners();
                        this.connect();
                    }
                };
            }

            async connect() {
                try {
                    console.log('Attempting to connect to vMix API at:', this.vmixHost);
                    
                    // Force HTTP for API connections
                    const apiUrl = this.vmixHost.replace('https:', 'http:');
                    
                    const response = await fetch(apiUrl + '/api/', {
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Access-Control-Allow-Origin': '*'
                        }
                    });
                    
                    const text = await response.text();
                    
                    if (text.includes('<vmix>')) {
                        console.log('Successfully connected to vMix API');
                        this.connected = true;
                        this.statusElement.textContent = 'Connected';
                        this.statusElement.classList.remove('disconnected');
                        this.statusElement.classList.add('connected');
                        
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(text, "text/xml");
                        
                        // Find PowerPoint input
                        const inputs = Array.from(xmlDoc.getElementsByTagName('input'));
                        const pptInput = inputs.find(input => 
                            input.getAttribute('type') === 'PowerPoint' || 
                            (input.getAttribute('title') || '').toLowerCase().includes('ppt')
                        );

                        if (pptInput) {
                            this.powerPointInput = pptInput.getAttribute('number');
                            console.log('Found PowerPoint input:', this.powerPointInput);
                            this.startPolling();
                        }
                    }
                } catch (error) {
                    console.error('Error connecting to vMix:', error);
                    this.statusElement.textContent = 'Connection Failed - Click to Retry';
                    this.statusElement.classList.remove('connected');
                    this.statusElement.classList.add('disconnected');
                    this.statusElement.style.cursor = 'pointer';
                    this.statusElement.onclick = () => this.promptForConnection();
                }
            }

            startPolling() {
                // Poll every second for updates
                this.pollInterval = setInterval(() => {
                    this.updateSlideInfo();
                }, 1000);
            }

            initializeEventListeners() {
                this.prevButton.addEventListener('click', () => this.previousSlide());
                this.nextButton.addEventListener('click', () => this.nextSlide());
            }

            async updateSlideInfo() {
                if (!this.connected || !this.powerPointInput) return;

                try {
                    const response = await fetch(`${this.vmixHost}/api/`, {
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    const text = await response.text();
                        const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(text, "text/xml");
                        
                        const input = xmlDoc.querySelector(`input[number="${this.powerPointInput}"]`);
                        if (input) {
                        // Get the title which contains slide info
                        const title = input.getAttribute('title') || '';
                        console.log('PowerPoint title:', title);
                        
                        // Extract slide number from title (assuming format "PPT - SlideX")
                        const slideMatch = title.match(/Slide(\d+)/i);
                        if (slideMatch) {
                            const currentSlide = slideMatch[1];
                            // For now hardcode total slides or get it from somewhere else
                            const totalSlides = 10; // Update this with actual total
                            this.slideInfo.textContent = `Slide ${currentSlide} of ${totalSlides}`;
                        } else {
                            this.slideInfo.textContent = title;
                        }
                    }
                } catch (error) {
                    console.error('Error updating slide info:', error);
                }
            }

            async nextSlide() {
                if (!this.powerPointInput) return;
                try {
                    const response = await fetch(`${this.vmixHost}/api/?Function=NextItem&Input=${this.powerPointInput}`, {
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    const text = await response.text();
                    if (!text.includes('OK')) {
                        throw new Error('API response not OK');
                    }
                    // Update slide info immediately after changing slides
                    await this.updateSlideInfo();
                } catch (error) {
                    console.error('Error advancing slide:', error);
                }
            }

            async previousSlide() {
                if (!this.powerPointInput) return;
                try {
                    const response = await fetch(`${this.vmixHost}/api/?Function=PreviousItem&Input=${this.powerPointInput}`, {
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    const text = await response.text();
                    if (!text.includes('OK')) {
                        throw new Error('API response not OK');
                    }
                    // Update slide info immediately after changing slides
                    await this.updateSlideInfo();
                } catch (error) {
                    console.error('Error going back one slide:', error);
                }
            }

            async setupRemoteAccess() {
                try {
                    // Get public IP
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    this.publicIp = data.ip;
                    
                    if (this.role === this.roles.PRODUCER) {
                        // Create shareable links for hosts and guests
                        const baseUrl = window.location.origin + window.location.pathname;
                        
                        const shareDialog = document.createElement('div');
                        shareDialog.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: #2d2d2d;
                            padding: 20px;
                            border-radius: 8px;
                            z-index: 1001;
                            box-shadow: 0 0 20px rgba(0,0,0,0.5);
                            max-width: 80%;
                            width: 600px;
                        `;
                        
                        // Create links for both host and guest
                        const hostLink = `${baseUrl}?Key=${this.callKey}&Name=HOST&Role=host&ProducerIP=${this.publicIp}&ProducerPort=8088`;
                        const guestLink = `${baseUrl}?Key=${this.callKey}&Name=GUEST&Role=guest&ProducerIP=${this.publicIp}&ProducerPort=8088`;
                        
                        shareDialog.innerHTML = `
                            <h3>Remote Access Links</h3>
                            <p style="color: #ff9999; margin: 10px 0;">Important: Make sure port 8088 is forwarded to this computer!</p>
                            ${this.generateCallLinks()}
                            <div style="margin-top: 20px;">
                                <p>Test your setup: <a href="http://${this.publicIp}:8088/api/" target="_blank">Click here</a></p>
                                <button onclick="this.parentElement.remove()" style="margin-top: 10px;">Close</button>
                            </div>
                        `;
                        
                        document.body.appendChild(shareDialog);
                    }
                } catch (error) {
                    console.error('Error setting up remote access:', error);
                }
            }

            generateCallLinks() {
                const callCodes = {
                    hosts: [
                        { code: '5291486963', name: 'Host1' },
                        { code: '2362872170', name: 'Host2' },
                        { code: '4495848015', name: 'Host3' }
                    ],
                    guests: [
                        { code: '3118728628', name: 'Guest1' },
                        { code: '3199515614', name: 'Guest2' }
                    ],
                    producers: [
                        { code: '3729675049', name: 'Producer1' },
                        { code: '2085058768', name: 'Producer2' },
                        { code: '1889937177', name: 'Producer3' }
                    ]
                };

                let linksHtml = '';

                // Generate Host Links
                linksHtml += '<h4>Host Links:</h4>';
                callCodes.hosts.forEach(host => {
                    const vmixCallLink = `https://advanced.vmixcall.com/call.htm?Key=${host.code}&Name=${host.name}`;
                    
                    linksHtml += `
                        <div style="margin: 10px 0;">
                            <p>${host.name}:</p>
                            <input type="text" value="${vmixCallLink}" style="width: 100%; padding: 5px;" readonly>
                            <button onclick="navigator.clipboard.writeText('${vmixCallLink}').then(() => alert('${host.name} link copied!'))">
                                Copy Link
                            </button>
                        </div>
                    `;
                });

                // Generate Guest Links
                linksHtml += '<h4>Guest Links:</h4>';
                callCodes.guests.forEach(guest => {
                    const vmixCallLink = `https://advanced.vmixcall.com/call.htm?Key=${guest.code}&Name=${guest.name}`;
                    
                    linksHtml += `
                        <div style="margin: 10px 0;">
                            <p>${guest.name}:</p>
                            <input type="text" value="${vmixCallLink}" style="width: 100%; padding: 5px;" readonly>
                            <button onclick="navigator.clipboard.writeText('${vmixCallLink}').then(() => alert('${guest.name} link copied!'))">
                                Copy Link
                            </button>
                        </div>
                    `;
                });

                return linksHtml;
            }
        }

        // Initialize when page loads
        window.addEventListener('load', () => new VMixController());
    </script>
</body>
</html>
